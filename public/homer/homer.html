<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SYNTRISE HOMER ‚Äî Virtual Smart Home</title>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-tertiary: #1a1a24;
      --bg-room: #14141c;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-glow: rgba(99, 102, 241, 0.3);
      --success: #22c55e;
      --success-glow: rgba(34, 197, 94, 0.3);
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #2a2a3a;
      
      --light-on: #fbbf24;
      --light-glow: rgba(251, 191, 36, 0.4);
      --curtain-open: #60a5fa;
      --curtain-closed: #1e3a5f;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
    }

    /* === HEADER === */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      height: 60px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .logo h1 span {
      color: var(--accent);
    }

    .logo-subtitle {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .sun-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: var(--bg-tertiary);
      border-radius: 20px;
      font-size: 13px;
    }

    .time-display {
      text-align: center;
    }

    .time-display .time {
      font-size: 28px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: -1px;
    }

    .time-display .date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .presence-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .presence-badge:hover {
      background: var(--border);
    }

    .presence-badge.home {
      color: var(--success);
    }

    .presence-badge.away {
      color: var(--text-muted);
    }

    .temp-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 16px;
      font-size: 13px;
    }

    /* === MAIN LAYOUT === */
    .main-container {
      display: flex;
      height: calc(100vh - 60px);
    }

    /* === HOUSE PANEL === */
    .house-panel {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: var(--bg-primary);
    }

    .house-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      max-width: 700px;
      margin: 0 auto;
    }

    /* === ROOM CARD === */
    .room-card {
      background: var(--bg-room);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.3s;
    }

    .room-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .room-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-tertiary);
    }

    .room-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .room-name .emoji {
      font-size: 16px;
    }

    .room-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .room-content {
      padding: 16px;
      min-height: 140px;
      position: relative;
    }

    /* === WINDOW === */
    .window-frame {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 70px;
      height: 90px;
      border: 3px solid #4a5568;
      border-radius: 4px;
      overflow: hidden;
      background: linear-gradient(180deg, #0f172a, #1e293b);
      transition: all 0.5s;
    }

    .window-frame.day {
      background: linear-gradient(180deg, #38bdf8, #7dd3fc, #bae6fd);
    }

    .window-frame.sunrise {
      background: linear-gradient(180deg, #fda4af, #fdba74, #fef08a, #bae6fd);
    }

    .window-frame.sunset {
      background: linear-gradient(180deg, #7c3aed, #f472b6, #fb923c, #fbbf24);
    }

    .curtain {
      position: absolute;
      top: 0;
      height: 100%;
      width: 50%;
      background: repeating-linear-gradient(
        90deg,
        #6b7280 0px,
        #9ca3af 2px,
        #6b7280 4px
      );
      transition: transform 0.6s ease-in-out;
    }

    .curtain-left {
      left: 0;
      transform-origin: left center;
    }

    .curtain-right {
      right: 0;
      transform-origin: right center;
    }

    .curtain.open {
      transform: scaleX(0.12);
    }

    /* === DEVICES === */
    .devices-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .device-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 70px;
    }

    .device-btn:hover {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
    }

    .device-btn.on {
      background: rgba(251, 191, 36, 0.15);
    }

    .device-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: var(--bg-tertiary);
      transition: all 0.3s;
    }

    .device-btn.on .device-icon.light-icon {
      background: var(--light-on);
      box-shadow: 0 0 20px var(--light-glow);
    }

    .device-btn.on .device-icon.plug-icon {
      background: var(--success);
      box-shadow: 0 0 15px var(--success-glow);
    }

    .device-label {
      font-size: 10px;
      color: var(--text-secondary);
      text-align: center;
    }

    .device-state {
      font-size: 9px;
      color: var(--text-muted);
    }

    .device-btn.on .device-state {
      color: var(--light-on);
    }

    /* === CONTROL PANEL === */
    .control-panel {
      width: 380px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    /* === VOICE INPUT === */
    .voice-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .voice-btn {
      width: 100%;
      padding: 20px;
      border-radius: 16px;
      border: 2px dashed var(--border);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.2s;
    }

    .voice-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .voice-btn.recording {
      border-style: solid;
      border-color: var(--error);
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .voice-btn .mic-icon {
      font-size: 24px;
    }

    /* === TEXT INPUT === */
    .input-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
    }

    .text-input {
      flex: 1;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }

    .text-input:focus {
      border-color: var(--accent);
    }

    .text-input::placeholder {
      color: var(--text-muted);
    }

    .send-btn {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .send-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    /* === QUICK ACTIONS === */
    .quick-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .quick-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .quick-btn {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    .quick-btn .emoji {
      font-size: 16px;
    }

    /* === LOG === */
    .log-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .log-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .log-header h3 {
      font-size: 13px;
      font-weight: 600;
    }

    .clear-log-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
    }

    .clear-log-btn:hover {
      color: var(--text-primary);
    }

    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .log-entry {
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 8px;
      border-left: 3px solid var(--border);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .log-entry.command { border-left-color: var(--accent); }
    .log-entry.action { border-left-color: var(--success); }
    .log-entry.trigger { border-left-color: var(--warning); }
    .log-entry.error { border-left-color: var(--error); }
    .log-entry.system { border-left-color: var(--text-muted); }

    .log-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .log-message {
      font-size: 13px;
      line-height: 1.4;
    }

    /* === TIME CONTROLS (collapsed) === */
    .time-controls {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    .time-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .time-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      outline: none;
    }

    .time-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    .speed-btns {
      display: flex;
      gap: 4px;
    }

    .speed-btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      background: var(--bg-secondary);
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .speed-btn:hover, .speed-btn.active {
      background: var(--accent);
      color: white;
    }

    /* === RESPONSIVE === */
    @media (max-width: 900px) {
      .main-container {
        flex-direction: column;
      }

      .house-panel {
        flex: none;
        height: 50%;
      }

      .control-panel {
        width: 100%;
        flex: 1;
      }

      .house-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
    }

    @media (max-width: 600px) {
      .house-grid {
        grid-template-columns: 1fr;
      }

      .header-center {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- === HEADER === -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">üè†</div>
      <div>
        <h1>SYNTRISE <span>HOMER</span></h1>
        <div class="logo-subtitle">Virtual Smart Home</div>
      </div>
    </div>

    <div class="header-center">
      <div class="sun-badge" id="sunBadge">
        <span id="sunIcon">üåô</span>
        <span id="sunText">–ù–æ—á—å</span>
      </div>
      <div class="time-display">
        <div class="time" id="timeDisplay">08:00</div>
        <div class="date">–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</div>
      </div>
    </div>

    <div class="header-right">
      <div class="presence-badge home" id="presenceBadge" onclick="togglePresence()">
        <span id="presenceIcon">üè†</span>
        <span id="presenceText">–î–æ–º–∞</span>
      </div>
      <div class="temp-badge">
        <span>üå°Ô∏è</span>
        <span id="homeTemp">22¬∞C</span>
      </div>
    </div>
  </header>

  <!-- === MAIN === -->
  <div class="main-container">
    <!-- === HOUSE PANEL === -->
    <div class="house-panel">
      <div class="house-grid">
        
        <!-- –ì–û–°–¢–ò–ù–ê–Ø -->
        <div class="room-card" id="room-living">
          <div class="room-header">
            <div class="room-name">
              <span class="emoji">üõãÔ∏è</span>
              –ì–æ—Å—Ç–∏–Ω–∞—è
            </div>
            <div class="room-info">
              <span id="living-temp">22¬∞</span>
            </div>
          </div>
          <div class="room-content">
            <div class="window-frame" id="living-window">
              <div class="curtain curtain-left" id="living-curtain-l"></div>
              <div class="curtain curtain-right" id="living-curtain-r"></div>
            </div>
            <div class="devices-grid">
              <button class="device-btn" onclick="toggle('living-light')" id="btn-living-light">
                <div class="device-icon light-icon">üí°</div>
                <div class="device-label">–õ—é—Å—Ç—Ä–∞</div>
                <div class="device-state" id="state-living-light">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggle('living-lamp')" id="btn-living-lamp">
                <div class="device-icon light-icon">üõãÔ∏è</div>
                <div class="device-label">–¢–æ—Ä—à–µ—Ä</div>
                <div class="device-state" id="state-living-lamp">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggle('living-tv')" id="btn-living-tv">
                <div class="device-icon plug-icon">üì∫</div>
                <div class="device-label">TV</div>
                <div class="device-state" id="state-living-tv">–í—ã–∫–ª</div>
              </button>
            </div>
          </div>
        </div>

        <!-- –°–ü–ê–õ–¨–ù–Ø -->
        <div class="room-card" id="room-bedroom">
          <div class="room-header">
            <div class="room-name">
              <span class="emoji">üõèÔ∏è</span>
              –°–ø–∞–ª—å–Ω—è
            </div>
            <div class="room-info">
              <span id="bedroom-temp">20¬∞</span>
            </div>
          </div>
          <div class="room-content">
            <div class="window-frame" id="bedroom-window">
              <div class="curtain curtain-left" id="bedroom-curtain-l"></div>
              <div class="curtain curtain-right" id="bedroom-curtain-r"></div>
            </div>
            <div class="devices-grid">
              <button class="device-btn" onclick="toggle('bedroom-light')" id="btn-bedroom-light">
                <div class="device-icon light-icon">üí°</div>
                <div class="device-label">–°–≤–µ—Ç</div>
                <div class="device-state" id="state-bedroom-light">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggle('bedroom-lamp')" id="btn-bedroom-lamp">
                <div class="device-icon light-icon">üåô</div>
                <div class="device-label">–ù–æ—á–Ω–∏–∫</div>
                <div class="device-state" id="state-bedroom-lamp">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggleCurtain('bedroom')" id="btn-bedroom-curtain">
                <div class="device-icon">ü™ü</div>
                <div class="device-label">–®—Ç–æ—Ä—ã</div>
                <div class="device-state" id="state-bedroom-curtain">–ó–∞–∫—Ä</div>
              </button>
            </div>
          </div>
        </div>

        <!-- –ö–£–•–ù–Ø -->
        <div class="room-card" id="room-kitchen">
          <div class="room-header">
            <div class="room-name">
              <span class="emoji">üç≥</span>
              –ö—É—Ö–Ω—è
            </div>
            <div class="room-info">
              <span id="kitchen-temp">23¬∞</span>
            </div>
          </div>
          <div class="room-content">
            <div class="window-frame" id="kitchen-window">
              <div class="curtain curtain-left" id="kitchen-curtain-l"></div>
              <div class="curtain curtain-right" id="kitchen-curtain-r"></div>
            </div>
            <div class="devices-grid">
              <button class="device-btn" onclick="toggle('kitchen-light')" id="btn-kitchen-light">
                <div class="device-icon light-icon">üí°</div>
                <div class="device-label">–°–≤–µ—Ç</div>
                <div class="device-state" id="state-kitchen-light">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggle('kitchen-kettle')" id="btn-kitchen-kettle">
                <div class="device-icon plug-icon">‚òï</div>
                <div class="device-label">–ß–∞–π–Ω–∏–∫</div>
                <div class="device-state" id="state-kitchen-kettle">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggle('kitchen-coffee')" id="btn-kitchen-coffee">
                <div class="device-icon plug-icon">‚òï</div>
                <div class="device-label">–ö–æ—Ñ–µ</div>
                <div class="device-state" id="state-kitchen-coffee">–í—ã–∫–ª</div>
              </button>
            </div>
          </div>
        </div>

        <!-- –ö–ê–ë–ò–ù–ï–¢ -->
        <div class="room-card" id="room-office">
          <div class="room-header">
            <div class="room-name">
              <span class="emoji">üíº</span>
              –ö–∞–±–∏–Ω–µ—Ç
            </div>
            <div class="room-info">
              <span id="office-temp">21¬∞</span>
            </div>
          </div>
          <div class="room-content">
            <div class="window-frame" id="office-window">
              <div class="curtain curtain-left" id="office-curtain-l"></div>
              <div class="curtain curtain-right" id="office-curtain-r"></div>
            </div>
            <div class="devices-grid">
              <button class="device-btn" onclick="toggle('office-light')" id="btn-office-light">
                <div class="device-icon light-icon">üí°</div>
                <div class="device-label">–°–≤–µ—Ç</div>
                <div class="device-state" id="state-office-light">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggle('office-pc')" id="btn-office-pc">
                <div class="device-icon plug-icon">üñ•Ô∏è</div>
                <div class="device-label">–ü–ö</div>
                <div class="device-state" id="state-office-pc">–í—ã–∫–ª</div>
              </button>
              <button class="device-btn" onclick="toggleCurtain('office')" id="btn-office-curtain">
                <div class="device-icon">ü™ü</div>
                <div class="device-label">–®—Ç–æ—Ä—ã</div>
                <div class="device-state" id="state-office-curtain">–ó–∞–∫—Ä</div>
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- === CONTROL PANEL === -->
    <div class="control-panel">
      <!-- VOICE INPUT -->
      <div class="voice-section">
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
          <span class="mic-icon" id="micIcon">üé§</span>
          <span id="voiceText">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å</span>
        </button>
      </div>

      <!-- TEXT INPUT -->
      <div class="input-section">
        <div class="input-wrapper">
          <input 
            type="text" 
            class="text-input" 
            id="textInput" 
            placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..."
            onkeydown="if(event.key==='Enter') executeCommand()"
          >
          <button class="send-btn" onclick="executeCommand()">‚Üí</button>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="quick-section">
        <div class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</div>
        <div class="quick-grid">
          <button class="quick-btn" onclick="scene('morning')">
            <span class="emoji">üåÖ</span>
            –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ
          </button>
          <button class="quick-btn" onclick="scene('evening')">
            <span class="emoji">üåô</span>
            –°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏
          </button>
          <button class="quick-btn" onclick="scene('allOff')">
            <span class="emoji">üëã</span>
            –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å—ë
          </button>
          <button class="quick-btn" onclick="scene('movie')">
            <span class="emoji">üé¨</span>
            –ö–∏–Ω–æ
          </button>
        </div>
      </div>

      <!-- LOG -->
      <div class="log-section">
        <div class="log-header">
          <h3>üìã –õ–æ–≥ –∫–æ–º–∞–Ω–¥</h3>
          <button class="clear-log-btn" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="log-content" id="logContent">
          <div class="log-entry system">
            <div class="log-time">–°–∏—Å—Ç–µ–º–∞</div>
            <div class="log-message">üè† HOMER –∑–∞–ø—É—â–µ–Ω. –°–∫–∞–∂–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É!</div>
          </div>
        </div>
      </div>

      <!-- TIME CONTROLS -->
      <div class="time-controls">
        <div class="time-row">
          <input type="range" class="time-slider" id="timeSlider" min="0" max="1440" value="480" oninput="setTime(this.value)">
          <div class="speed-btns">
            <button class="speed-btn" onclick="setSpeed(0)">‚è∏Ô∏è</button>
            <button class="speed-btn active" onclick="setSpeed(1)" id="speed-1">1x</button>
            <button class="speed-btn" onclick="setSpeed(60)" id="speed-60">60x</button>
            <button class="speed-btn" onclick="setSpeed(360)" id="speed-360">‚è©</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // STATE
    // ============================================

    const STATE = {
      // Time
      time: 480, // minutes from midnight (08:00)
      speed: 1,
      lastTick: Date.now(),
      sunrise: 360,  // 06:00
      sunset: 1200,  // 20:00

      // Presence
      isHome: true,

      // Devices
      devices: {
        'living-light': false,
        'living-lamp': false,
        'living-tv': false,
        'bedroom-light': false,
        'bedroom-lamp': false,
        'kitchen-light': false,
        'kitchen-kettle': false,
        'kitchen-coffee': false,
        'office-light': false,
        'office-pc': false
      },

      // Curtains (true = open)
      curtains: {
        'living': false,
        'bedroom': false,
        'kitchen': false,
        'office': false
      },

      // Temperature
      temp: 22,

      // Voice
      isRecording: false,
      recognition: null
    };

    // ============================================
    // TIME
    // ============================================

    function updateTime() {
      const now = Date.now();
      const elapsed = (now - STATE.lastTick) / 1000;
      STATE.lastTick = now;

      if (STATE.speed > 0) {
        STATE.time += (elapsed / 60) * STATE.speed;
        if (STATE.time >= 1440) STATE.time -= 1440;
      }

      // Update display
      const h = Math.floor(STATE.time / 60);
      const m = Math.floor(STATE.time % 60);
      const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
      document.getElementById('timeDisplay').textContent = timeStr;
      document.getElementById('timeSlider').value = STATE.time;

      // Update sun state
      updateSunState();
    }

    function updateSunState() {
      const t = STATE.time;
      let sunIcon, sunText, windowClass;

      if (t >= STATE.sunrise - 30 && t < STATE.sunrise + 60) {
        sunIcon = 'üåÖ'; sunText = '–†–∞—Å—Å–≤–µ—Ç'; windowClass = 'sunrise';
      } else if (t >= STATE.sunrise + 60 && t < STATE.sunset - 60) {
        sunIcon = '‚òÄÔ∏è'; sunText = '–î–µ–Ω—å'; windowClass = 'day';
      } else if (t >= STATE.sunset - 60 && t < STATE.sunset + 30) {
        sunIcon = 'üåá'; sunText = '–ó–∞–∫–∞—Ç'; windowClass = 'sunset';
      } else {
        sunIcon = 'üåô'; sunText = '–ù–æ—á—å'; windowClass = '';
      }

      document.getElementById('sunIcon').textContent = sunIcon;
      document.getElementById('sunText').textContent = sunText;

      // Update windows
      ['living', 'bedroom', 'kitchen', 'office'].forEach(room => {
        const win = document.getElementById(`${room}-window`);
        win.className = 'window-frame ' + windowClass;
      });
    }

    function setTime(minutes) {
      STATE.time = parseInt(minutes);
      updateTime();
    }

    function setSpeed(speed) {
      STATE.speed = speed;
      document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
      if (speed === 1) document.getElementById('speed-1').classList.add('active');
      if (speed === 60) document.getElementById('speed-60').classList.add('active');
      if (speed === 360) document.getElementById('speed-360').classList.add('active');
    }

    // ============================================
    // DEVICES
    // ============================================

    function toggle(deviceId) {
      STATE.devices[deviceId] = !STATE.devices[deviceId];
      updateDeviceUI(deviceId);
      
      const name = getDeviceName(deviceId);
      const state = STATE.devices[deviceId] ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω';
      log('action', `${name} ${state}`);
    }

    function setDevice(deviceId, on) {
      STATE.devices[deviceId] = on;
      updateDeviceUI(deviceId);
    }

    function updateDeviceUI(deviceId) {
      const btn = document.getElementById(`btn-${deviceId}`);
      const state = document.getElementById(`state-${deviceId}`);
      
      if (btn) {
        if (STATE.devices[deviceId]) {
          btn.classList.add('on');
        } else {
          btn.classList.remove('on');
        }
      }
      
      if (state) {
        state.textContent = STATE.devices[deviceId] ? '–í–∫–ª' : '–í—ã–∫–ª';
      }
    }

    function toggleCurtain(room) {
      STATE.curtains[room] = !STATE.curtains[room];
      updateCurtainUI(room);
      
      const state = STATE.curtains[room] ? '–æ—Ç–∫—Ä—ã—Ç—ã' : '–∑–∞–∫—Ä—ã—Ç—ã';
      log('action', `–®—Ç–æ—Ä—ã –≤ ${getRoomName(room)} ${state}`);
    }

    function setCurtain(room, open) {
      STATE.curtains[room] = open;
      updateCurtainUI(room);
    }

    function updateCurtainUI(room) {
      const l = document.getElementById(`${room}-curtain-l`);
      const r = document.getElementById(`${room}-curtain-r`);
      const state = document.getElementById(`state-${room}-curtain`);
      
      if (STATE.curtains[room]) {
        l?.classList.add('open');
        r?.classList.add('open');
      } else {
        l?.classList.remove('open');
        r?.classList.remove('open');
      }
      
      if (state) {
        state.textContent = STATE.curtains[room] ? '–û—Ç–∫—Ä' : '–ó–∞–∫—Ä';
      }
    }

    // ============================================
    // PRESENCE
    // ============================================

    function togglePresence() {
      STATE.isHome = !STATE.isHome;
      updatePresenceUI();
      
      if (STATE.isHome) {
        log('trigger', 'üè† –•–æ–∑—è–∏–Ω –¥–æ–º–∞');
      } else {
        log('trigger', 'üëã –í—Å–µ —É—à–ª–∏');
        scene('allOff');
      }
    }

    function updatePresenceUI() {
      const badge = document.getElementById('presenceBadge');
      const icon = document.getElementById('presenceIcon');
      const text = document.getElementById('presenceText');

      if (STATE.isHome) {
        badge.className = 'presence-badge home';
        icon.textContent = 'üè†';
        text.textContent = '–î–æ–º–∞';
      } else {
        badge.className = 'presence-badge away';
        icon.textContent = 'üëã';
        text.textContent = '–ù–µ—Ç –¥–æ–º–∞';
      }
    }

    // ============================================
    // SCENES
    // ============================================

    function scene(name) {
      switch(name) {
        case 'morning':
          log('trigger', 'üåÖ –°—Ü–µ–Ω–∞: –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ');
          ['living', 'bedroom', 'kitchen', 'office'].forEach(r => setCurtain(r, true));
          setDevice('kitchen-coffee', true);
          log('action', '‚òï –ö–æ—Ñ–µ–≤–∞—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞, —à—Ç–æ—Ä—ã –æ—Ç–∫—Ä—ã—Ç—ã');
          break;

        case 'evening':
          log('trigger', 'üåô –°—Ü–µ–Ω–∞: –°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏');
          Object.keys(STATE.devices).forEach(d => setDevice(d, false));
          ['living', 'bedroom', 'kitchen', 'office'].forEach(r => setCurtain(r, false));
          setDevice('bedroom-lamp', true);
          log('action', 'üõèÔ∏è –í—Å—ë –≤—ã–∫–ª—é—á–µ–Ω–æ, –Ω–æ—á–Ω–∏–∫ –≤–∫–ª—é—á–µ–Ω');
          break;

        case 'allOff':
          log('trigger', 'üëã –°—Ü–µ–Ω–∞: –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å—ë');
          Object.keys(STATE.devices).forEach(d => setDevice(d, false));
          log('action', 'üîå –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤—ã–∫–ª—é—á–µ–Ω—ã');
          break;

        case 'movie':
          log('trigger', 'üé¨ –°—Ü–µ–Ω–∞: –ö–∏–Ω–æ');
          ['living', 'bedroom', 'kitchen', 'office'].forEach(r => setCurtain(r, false));
          Object.keys(STATE.devices).forEach(d => {
            if (d.includes('light')) setDevice(d, false);
          });
          setDevice('living-tv', true);
          setDevice('living-lamp', true);
          log('action', 'üì∫ TV –≤–∫–ª—é—á–µ–Ω, –ø—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π —Å–≤–µ—Ç');
          break;
      }
    }

    // ============================================
    // COMMAND PROCESSING
    // ============================================

    function executeCommand() {
      const input = document.getElementById('textInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      log('command', `üìù "${text}"`);
      processCommand(text);
      input.value = '';
    }

    function processCommand(text) {
      const lower = text.toLowerCase();

      // === LIGHT ON ===
      if (/–≤–∫–ª—é—á–∏.*(—Å–≤–µ—Ç|–ª—é—Å—Ç—Ä|–ª–∞–º–ø|–Ω–æ—á–Ω–∏–∫|—Ç–æ—Ä—à–µ—Ä)/i.test(lower)) {
        const room = detectRoom(lower);
        if (room) {
          const lightId = `${room}-light`;
          setDevice(lightId, true);
          updateDeviceUI(lightId);
          log('action', `üí° –°–≤–µ—Ç –≤ ${getRoomName(room)} –≤–∫–ª—é—á–µ–Ω`);
        } else {
          // All lights
          Object.keys(STATE.devices).forEach(d => {
            if (d.includes('light')) {
              setDevice(d, true);
              updateDeviceUI(d);
            }
          });
          log('action', 'üí° –í–µ—Å—å —Å–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω');
        }
        return;
      }

      // === LIGHT OFF ===
      if (/–≤—ã–∫–ª—é—á–∏.*(—Å–≤–µ—Ç|–ª—é—Å—Ç—Ä|–ª–∞–º–ø|–Ω–æ—á–Ω–∏–∫|—Ç–æ—Ä—à–µ—Ä)/i.test(lower)) {
        const room = detectRoom(lower);
        if (room) {
          const lightId = `${room}-light`;
          setDevice(lightId, false);
          updateDeviceUI(lightId);
          log('action', `üí° –°–≤–µ—Ç –≤ ${getRoomName(room)} –≤—ã–∫–ª—é—á–µ–Ω`);
        } else {
          Object.keys(STATE.devices).forEach(d => {
            if (d.includes('light')) {
              setDevice(d, false);
              updateDeviceUI(d);
            }
          });
          log('action', 'üí° –í–µ—Å—å —Å–≤–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω');
        }
        return;
      }

      // === CURTAINS OPEN ===
      if (/–æ—Ç–∫—Ä–æ–π.*—à—Ç–æ—Ä/i.test(lower)) {
        const room = detectRoom(lower);
        if (room) {
          setCurtain(room, true);
          updateCurtainUI(room);
          log('action', `ü™ü –®—Ç–æ—Ä—ã –≤ ${getRoomName(room)} –æ—Ç–∫—Ä—ã—Ç—ã`);
        } else {
          ['living', 'bedroom', 'kitchen', 'office'].forEach(r => {
            setCurtain(r, true);
            updateCurtainUI(r);
          });
          log('action', 'ü™ü –í—Å–µ —à—Ç–æ—Ä—ã –æ—Ç–∫—Ä—ã—Ç—ã');
        }
        return;
      }

      // === CURTAINS CLOSE ===
      if (/–∑–∞–∫—Ä–æ–π.*—à—Ç–æ—Ä/i.test(lower)) {
        const room = detectRoom(lower);
        if (room) {
          setCurtain(room, false);
          updateCurtainUI(room);
          log('action', `ü™ü –®—Ç–æ—Ä—ã –≤ ${getRoomName(room)} –∑–∞–∫—Ä—ã—Ç—ã`);
        } else {
          ['living', 'bedroom', 'kitchen', 'office'].forEach(r => {
            setCurtain(r, false);
            updateCurtainUI(r);
          });
          log('action', 'ü™ü –í—Å–µ —à—Ç–æ—Ä—ã –∑–∞–∫—Ä—ã—Ç—ã');
        }
        return;
      }

      // === APPLIANCES ===
      if (/–≤–∫–ª—é—á–∏.*—á–∞–π–Ω–∏–∫/i.test(lower)) {
        setDevice('kitchen-kettle', true);
        updateDeviceUI('kitchen-kettle');
        log('action', '‚òï –ß–∞–π–Ω–∏–∫ –≤–∫–ª—é—á–µ–Ω');
        return;
      }

      if (/–≤–∫–ª—é—á–∏.*–∫–æ—Ñ–µ/i.test(lower)) {
        setDevice('kitchen-coffee', true);
        updateDeviceUI('kitchen-coffee');
        log('action', '‚òï –ö–æ—Ñ–µ–≤–∞—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞');
        return;
      }

      if (/–≤–∫–ª—é—á–∏.*(—Ç–µ–ª–µ–≤–∏–∑–æ—Ä|tv|—Ç–≤)/i.test(lower)) {
        setDevice('living-tv', true);
        updateDeviceUI('living-tv');
        log('action', 'üì∫ –¢–µ–ª–µ–≤–∏–∑–æ—Ä –≤–∫–ª—é—á–µ–Ω');
        return;
      }

      if (/–≤–∫–ª—é—á–∏.*(–∫–æ–º–ø—å—é—Ç–µ—Ä|–ø–∫|pc)/i.test(lower)) {
        setDevice('office-pc', true);
        updateDeviceUI('office-pc');
        log('action', 'üñ•Ô∏è –ö–æ–º–ø—å—é—Ç–µ—Ä –≤–∫–ª—é—á–µ–Ω');
        return;
      }

      // === SCENES ===
      if (/–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ|–ø—Ä–æ—Å—ã–ø–∞|–ø–æ–¥—ä[–µ—ë]–º/i.test(lower)) {
        scene('morning');
        return;
      }

      if (/—Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏|—Å–ø–∞—Ç—å|–æ—Ç–±–æ–π/i.test(lower)) {
        scene('evening');
        return;
      }

      if (/–≤—ã–∫–ª—é—á–∏ –≤—Å[–µ—ë]|–≤—Å[–µ—ë] –≤—ã–∫–ª—é—á–∏/i.test(lower)) {
        scene('allOff');
        return;
      }

      if (/–∫–∏–Ω–æ|—Ñ–∏–ª—å–º|movie/i.test(lower)) {
        scene('movie');
        return;
      }

      // === TEMPERATURE ===
      const tempMatch = lower.match(/(\d+)\s*(–≥—Ä–∞–¥—É—Å|¬∞|degree)/i);
      if (tempMatch || /—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä/i.test(lower)) {
        const temp = tempMatch ? tempMatch[1] : '22';
        STATE.temp = parseInt(temp);
        document.getElementById('homeTemp').textContent = `${temp}¬∞C`;
        log('action', `üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${temp}¬∞C`);
        return;
      }

      // === NOT RECOGNIZED ===
      log('error', '‚ùì –ù–µ –ø–æ–Ω—è–ª –∫–æ–º–∞–Ω–¥—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: "–≤–∫–ª—é—á–∏ —Å–≤–µ—Ç –≤ –≥–æ—Å—Ç–∏–Ω–æ–π"');
    }

    function detectRoom(text) {
      if (/–≥–æ—Å—Ç–∏–Ω/i.test(text)) return 'living';
      if (/—Å–ø–∞–ª—å–Ω/i.test(text)) return 'bedroom';
      if (/–∫—É—Ö–Ω/i.test(text)) return 'kitchen';
      if (/–∫–∞–±–∏–Ω–µ—Ç|–æ—Ñ–∏—Å/i.test(text)) return 'office';
      return null;
    }

    function getRoomName(room) {
      const names = { living: '–≥–æ—Å—Ç–∏–Ω–æ–π', bedroom: '—Å–ø–∞–ª—å–Ω–µ', kitchen: '–∫—É—Ö–Ω–µ', office: '–∫–∞–±–∏–Ω–µ—Ç–µ' };
      return names[room] || room;
    }

    function getDeviceName(id) {
      const names = {
        'living-light': 'üí° –õ—é—Å—Ç—Ä–∞ (–≥–æ—Å—Ç–∏–Ω–∞—è)',
        'living-lamp': 'üõãÔ∏è –¢–æ—Ä—à–µ—Ä',
        'living-tv': 'üì∫ –¢–µ–ª–µ–≤–∏–∑–æ—Ä',
        'bedroom-light': 'üí° –°–≤–µ—Ç (—Å–ø–∞–ª—å–Ω—è)',
        'bedroom-lamp': 'üåô –ù–æ—á–Ω–∏–∫',
        'kitchen-light': 'üí° –°–≤–µ—Ç (–∫—É—Ö–Ω—è)',
        'kitchen-kettle': '‚òï –ß–∞–π–Ω–∏–∫',
        'kitchen-coffee': '‚òï –ö–æ—Ñ–µ–≤–∞—Ä–∫–∞',
        'office-light': 'üí° –°–≤–µ—Ç (–∫–∞–±–∏–Ω–µ—Ç)',
        'office-pc': 'üñ•Ô∏è –ö–æ–º–ø—å—é—Ç–µ—Ä'
      };
      return names[id] || id;
    }

    // ============================================
    // VOICE
    // ============================================

    function toggleVoice() {
      if (STATE.isRecording) {
        stopVoice();
      } else {
        startVoice();
      }
    }

    function startVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        log('error', '‚ùå –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      STATE.recognition = new SpeechRecognition();
      STATE.recognition.lang = 'ru-RU';
      STATE.recognition.continuous = false;
      STATE.recognition.interimResults = true;

      STATE.recognition.onstart = () => {
        STATE.isRecording = true;
        updateVoiceUI();
        log('system', 'üé§ –°–ª—É—à–∞—é...');
      };

      STATE.recognition.onresult = (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        document.getElementById('textInput').value = transcript;

        if (event.results[event.results.length - 1].isFinal) {
          log('command', `üé§ "${transcript}"`);
          processCommand(transcript);
          document.getElementById('textInput').value = '';
        }
      };

      STATE.recognition.onerror = (event) => {
        log('error', `‚ùå –û—à–∏–±–∫–∞: ${event.error}`);
        stopVoice();
      };

      STATE.recognition.onend = () => {
        stopVoice();
      };

      STATE.recognition.start();
    }

    function stopVoice() {
      if (STATE.recognition) {
        STATE.recognition.stop();
        STATE.recognition = null;
      }
      STATE.isRecording = false;
      updateVoiceUI();
    }

    function updateVoiceUI() {
      const btn = document.getElementById('voiceBtn');
      const icon = document.getElementById('micIcon');
      const text = document.getElementById('voiceText');

      if (STATE.isRecording) {
        btn.classList.add('recording');
        icon.textContent = 'üî¥';
        text.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
      } else {
        btn.classList.remove('recording');
        icon.textContent = 'üé§';
        text.textContent = '–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å';
      }
    }

    // ============================================
    // LOG
    // ============================================

    function log(type, message) {
      const container = document.getElementById('logContent');
      const time = document.getElementById('timeDisplay').textContent;

      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `
        <div class="log-time">${time}</div>
        <div class="log-message">${message}</div>
      `;

      container.insertBefore(entry, container.firstChild);

      // Keep last 30
      while (container.children.length > 30) {
        container.removeChild(container.lastChild);
      }
    }

    function clearLog() {
      document.getElementById('logContent').innerHTML = '';
      log('system', 'üìã –õ–æ–≥ –æ—á–∏—â–µ–Ω');
    }

    // ============================================
    // EXTERNAL API
    // ============================================

    window.HOMER = {
      command: processCommand,
      toggle: toggle,
      setDevice: setDevice,
      setCurtain: setCurtain,
      scene: scene,
      getState: () => ({ ...STATE }),
      log: log
    };

    // ============================================
    // INIT
    // ============================================

    setInterval(updateTime, 1000);
    updateTime();
    updatePresenceUI();

    // Welcome
    setTimeout(() => {
      log('system', 'üí¨ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: "–í–∫–ª—é—á–∏ —Å–≤–µ—Ç –≤ –≥–æ—Å—Ç–∏–Ω–æ–π"');
    }, 1000);
  </script>
</body>
</html>
